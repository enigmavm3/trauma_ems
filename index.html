<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é‡å¤§å¤–å‚·æ´¾é£æ±ºç­–è¼”åŠ©ç³»çµ±</title>
<style>
  :root {
    --primary: #1a56db;
    --primary-light: #e8eefb;
    --danger: #dc2626;
    --danger-light: #fef2f2;
    --danger-bg: #fde8e8;
    --success: #16a34a;
    --success-light: #f0fdf4;
    --warning: #d97706;
    --warning-light: #fffbeb;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-500: #6b7280;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --radius: 12px;
    --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
    background: linear-gradient(135deg, #f0f4ff 0%, #e8eefb 100%);
    min-height: 100vh;
    color: var(--gray-800);
    line-height: 1.6;
  }

  .app-header {
    background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
    color: white;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 12px rgba(26,86,219,0.3);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .app-header h1 { font-size: 20px; font-weight: 700; letter-spacing: 1px; }
  .app-header .subtitle { font-size: 12px; opacity: 0.85; margin-top: 2px; }

  .header-actions { display: flex; gap: 8px; }

  .header-btn {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }
  .header-btn:hover { background: rgba(255,255,255,0.25); }

  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px 16px 100px;
  }

  /* Progress bar */
  .progress-bar {
    background: var(--gray-200);
    border-radius: 20px;
    height: 8px;
    margin-bottom: 20px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), #3b82f6);
    border-radius: 20px;
    transition: width 0.5s ease;
  }

  /* Dispatch status banner */
  .dispatch-banner {
    padding: 16px 20px;
    border-radius: var(--radius);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s;
    box-shadow: var(--shadow);
  }
  .dispatch-banner.level-normal { background: var(--success-light); color: var(--success); border: 2px solid var(--success); }
  .dispatch-banner.level-warning { background: var(--warning-light); color: var(--warning); border: 2px solid var(--warning); }
  .dispatch-banner.level-critical { background: var(--danger-bg); color: var(--danger); border: 2px solid var(--danger); animation: pulse 2s infinite; }

  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(220,38,38,0.3); }
    50% { box-shadow: 0 0 0 8px rgba(220,38,38,0); }
  }

  .dispatch-banner .icon { font-size: 28px; }
  .dispatch-banner .details { flex: 1; }
  .dispatch-banner .details .label { font-size: 12px; opacity: 0.8; font-weight: 400; }

  /* Card styles */
  .card {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 16px;
    border: 1px solid var(--gray-200);
    animation: fadeInUp 0.35s ease;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .card.completed {
    opacity: 0.65;
    border-color: var(--success);
    background: var(--success-light);
  }
  .card.completed .card-title::after {
    content: ' âœ“';
    color: var(--success);
  }

  .card-step {
    display: inline-block;
    background: var(--primary);
    color: white;
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 10px;
  }

  .card-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 6px;
  }

  .card-desc {
    font-size: 14px;
    color: var(--gray-500);
    margin-bottom: 16px;
  }

  .card-hint {
    background: var(--warning-light);
    border-left: 4px solid var(--warning);
    padding: 10px 14px;
    border-radius: 0 8px 8px 0;
    font-size: 13px;
    color: var(--gray-700);
    margin-bottom: 16px;
  }

  /* Form elements */
  .form-group { margin-bottom: 16px; }
  .form-group label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 6px;
  }

  .form-input, .form-select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    font-size: 16px;
    font-family: inherit;
    transition: border-color 0.2s;
    background: white;
  }
  .form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(26,86,219,0.15);
  }

  /* Big choice buttons */
  .choice-grid { display: flex; flex-direction: column; gap: 10px; }

  .choice-btn {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 20px;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius);
    background: white;
    cursor: pointer;
    font-size: 16px;
    font-family: inherit;
    color: var(--gray-800);
    transition: all 0.2s;
    text-align: left;
    width: 100%;
  }
  .choice-btn:hover {
    border-color: var(--primary);
    background: var(--primary-light);
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }
  .choice-btn.selected {
    border-color: var(--primary);
    background: var(--primary-light);
    font-weight: 600;
  }
  .choice-btn .choice-icon { font-size: 28px; min-width: 36px; text-align: center; }
  .choice-btn .choice-text .sub { font-size: 12px; color: var(--gray-500); font-weight: 400; }

  .choice-btn.danger-choice {
    border-color: var(--danger);
    background: var(--danger-light);
    color: var(--danger);
    font-weight: 600;
  }
  .choice-btn.danger-choice:hover {
    background: var(--danger-bg);
  }

  /* Yes/No buttons */
  .yn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .yn-btn {
    padding: 16px;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius);
    background: white;
    cursor: pointer;
    font-size: 18px;
    font-weight: 700;
    font-family: inherit;
    transition: all 0.2s;
    text-align: center;
  }
  .yn-btn.yes-btn:hover, .yn-btn.yes-btn.selected { background: var(--danger-bg); border-color: var(--danger); color: var(--danger); }
  .yn-btn.no-btn:hover, .yn-btn.no-btn.selected { background: var(--success-light); border-color: var(--success); color: var(--success); }

  /* Action buttons */
  .action-row { display: flex; gap: 10px; margin-top: 16px; }

  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
    flex: 1;
  }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: #1e40af; }
  .btn-primary:disabled { background: var(--gray-300); cursor: not-allowed; }
  .btn-secondary { background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--gray-300); }
  .btn-secondary:hover { background: var(--gray-200); }
  .btn-danger { background: var(--danger); color: white; }
  .btn-danger:hover { background: #b91c1c; }

  /* Summary */
  .summary-section {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    padding: 28px;
    margin-bottom: 16px;
    border: 2px solid var(--primary);
  }

  .summary-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 20px;
    text-align: center;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--gray-200);
  }

  .summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }

  .summary-item {
    padding: 12px;
    background: var(--gray-50);
    border-radius: 8px;
  }
  .summary-item .s-label { font-size: 12px; color: var(--gray-500); font-weight: 600; }
  .summary-item .s-value { font-size: 16px; font-weight: 600; color: var(--gray-800); }

  .dispatch-result {
    padding: 20px;
    border-radius: var(--radius);
    text-align: center;
    margin-top: 16px;
  }
  .dispatch-result.major {
    background: linear-gradient(135deg, #fef2f2, #fde8e8);
    border: 3px solid var(--danger);
  }
  .dispatch-result.normal {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border: 3px solid var(--success);
  }
  .dispatch-result .dr-title {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 8px;
  }
  .dispatch-result.major .dr-title { color: var(--danger); }
  .dispatch-result.normal .dr-title { color: var(--success); }
  .dispatch-result .dr-vehicles {
    font-size: 18px;
    font-weight: 600;
    margin-top: 10px;
  }

  .key-findings {
    background: var(--warning-light);
    border: 2px solid var(--warning);
    border-radius: var(--radius);
    padding: 16px;
    margin-top: 16px;
  }
  .key-findings h4 { color: var(--warning); margin-bottom: 8px; }
  .key-findings ul { padding-left: 20px; }
  .key-findings li { margin-bottom: 4px; font-size: 14px; }

  /* History log */
  .log-entry {
    padding: 8px 12px;
    background: var(--gray-50);
    border-radius: 6px;
    margin-bottom: 6px;
    font-size: 13px;
    display: flex;
    justify-content: space-between;
  }
  .log-entry .q { color: var(--gray-500); }
  .log-entry .a { font-weight: 600; }

  /* Timer */
  .timer {
    font-size: 14px;
    font-weight: 600;
    color: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* Responsive */
  @media (max-width: 600px) {
    .app-header h1 { font-size: 16px; }
    .container { padding: 12px 10px 100px; }
    .card { padding: 18px; }
    .summary-grid { grid-template-columns: 1fr; }
  }

  /* Print styles */
  @media print {
    .app-header { position: static; }
    .header-actions, .action-row, .btn { display: none !important; }
    .card.completed { opacity: 1; }
    body { background: white; }
  }

  .hidden { display: none !important; }

  /* Collapsible completed cards */
  .card.completed .card-body { display: none; }
  .card.completed:hover .card-body { display: block; }
  .card.completed .card-header { cursor: pointer; }

  /* Plain text summary box */
  .plaintext-box {
    margin-top: 20px;
    background: var(--gray-50);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .plaintext-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--gray-100);
    border-bottom: 1px solid var(--gray-200);
  }
  .plaintext-header h4 {
    color: var(--gray-700);
    font-size: 14px;
  }
  .copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
  }
  .copy-btn:hover { background: #1e40af; }
  .copy-btn.copied { background: var(--success); }
  .plaintext-content {
    padding: 16px;
    font-family: 'Consolas', 'Microsoft JhengHei', monospace;
    font-size: 13px;
    line-height: 1.8;
    white-space: pre-wrap;
    word-break: break-all;
    color: var(--gray-800);
    max-height: 400px;
    overflow-y: auto;
    user-select: all;
  }
</style>
</head>
<body>

<div class="app-header">
  <div>
    <h1>ğŸš‘ é‡å¤§å¤–å‚·æ´¾é£æ±ºç­–è¼”åŠ©ç³»çµ±</h1>
    <div class="subtitle">æ¡ƒåœ’å¸‚æ¶ˆé˜²å±€ â€” æ´¾é£å³æª¢å‚·é›™è»Œæ¨¡å¼</div>
  </div>
  <div style="display:flex; align-items:center; gap:16px;">
    <div class="timer" id="timer">â± 00:00</div>
    <div class="header-actions">
      <button class="header-btn" onclick="resetAll()">ğŸ”„ é‡æ–°é–‹å§‹</button>
      <button class="header-btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
    </div>
  </div>
</div>

<div class="container" id="app">
  <!-- Rendered by JS -->
</div>

<script>
// ===== STATE =====
const state = {
  step: 'basic',       // current step
  patientCount: 1,
  incidentType: '',
  isOHCA: false,
  gender: '',
  age: '',
  isMajor: false,
  dispatchLevel: 'normal', // normal, warning, critical
  vehicles: { ambulance: 1, rescue: 0 },
  findings: [],
  log: [],
  subStep: 0,
  subAnswers: {},
  startTime: Date.now(),
};

// ===== TIMER =====
setInterval(() => {
  const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
  const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
  const s = String(elapsed % 60).padStart(2, '0');
  document.getElementById('timer').textContent = `â± ${m}:${s}`;
}, 1000);

// ===== INCIDENT TYPES =====
const incidentTypes = [
  { id: 'fall', label: 'è·Œè½/è·³æ¨“/å¢œæ¨“/æ‘”å€’', icon: 'ğŸ—ï¸', sub: 'é«˜è™•å¢œè½ã€è·³æ¨“ã€å·¥åœ°å¢œè½ç­‰' },
  { id: 'vehicle', label: 'è»Šç¦', icon: 'ğŸš—', sub: 'æ±½æ©Ÿè»Šäº‹æ•…ã€è¡Œäººè¢«æ’ç­‰' },
  { id: 'machine', label: 'æ©Ÿå™¨è¨­å‚™ç©¿åˆº/å¤¾å‚·/å¤¾å›°', icon: 'âš™ï¸', sub: 'å·¥å» æ©Ÿå™¨æ²å…¥ã€ç©¿åˆºå‚·ç­‰' },
  { id: 'crush', label: 'å€’å¡Œ/é‡ç‰©å£“ç ¸/æ©åŸ‹', icon: 'ğŸšï¸', sub: 'å»ºç‰©å€’å¡Œã€é‡ç‰©å£“ä½ã€æ©åŸ‹ç­‰' },
  { id: 'stab', label: 'åˆ€å‚·/æ§å‚·', icon: 'ğŸ”ª', sub: 'ç©¿åˆºå‚·ã€ç å‚·ã€æ§å‚·ç­‰' },
  { id: 'burn', label: 'çˆ†ç‚¸/ç‡’ç‡™å‚·/ç«ç½', icon: 'ğŸ”¥', sub: 'çˆ†ç‚¸å‚·ã€å¤§é¢ç©ç‡’å‚·ç­‰' },
  { id: 'other', label: 'å…¶ä»–å¤–å‚·', icon: 'ğŸ©¹', sub: 'æººæ°´ã€é›»æ“Šå‚·ã€å…¶ä»–å‰µå‚·ç­‰' },
];

// ===== QUESTION TREES =====
const questionTrees = {
  fall: [
    {
      id: 'fall_trapped',
      question: 'æ‚£è€…æ˜¯å¦æœ‰å—å›°æˆ–å¡ä½ï¼Ÿéœ€ä¸éœ€è¦æœæ•‘å™¨æï¼Ÿ',
      hint: 'ä¾‹å¦‚ï¼šå¡åœ¨ç¸«éš™ä¸­ã€ç„¡æ³•è‡ªè¡Œè„«å›°ç­‰',
      type: 'yn',
      onYes: () => { addFinding('æ‚£è€…å—å›°ï¼Œéœ€æœæ•‘å™¨æ'); addVehicle('rescue'); },
    },
    {
      id: 'fall_gender',
      question: 'æ‚£è€…æ€§åˆ¥ï¼Ÿ',
      type: 'choice',
      options: [
        { label: 'ç”·æ€§', value: 'ç”·' },
        { label: 'å¥³æ€§', value: 'å¥³' },
        { label: 'ä¸è©³', value: 'ä¸è©³' },
      ],
      onSelect: (v) => { state.gender = v; },
    },
    {
      id: 'fall_age',
      question: 'æ‚£è€…å¹´ç´€ï¼Ÿ',
      hint: 'æ³¨æ„è€äººèˆ‡å°å…’ï¼Œä»–å€‘çš„åˆ¤æ–·æ¨™æº–ä¸åŒ',
      type: 'input',
      placeholder: 'ä¾‹å¦‚: 45æ­²ã€è€å¹´ã€å°å­©ç´„5æ­²',
      onSubmit: (v) => { state.age = v; },
    },
    {
      id: 'fall_is_child',
      question: 'æ‚£è€…æ˜¯å¦ç‚ºå°å…’ï¼ˆç´„12æ­²ä»¥ä¸‹ï¼‰ï¼Ÿ',
      type: 'yn',
      onYes: () => { state.subAnswers.isChild = true; },
      onNo: () => { state.subAnswers.isChild = false; },
    },
    {
      id: 'fall_height_adult',
      question: 'å¢œè½é«˜åº¦æ˜¯å¦å¤§æ–¼å…©å±¤æ¨“ï¼ˆç´„6å…¬å°ºï¼‰ï¼Ÿ',
      hint: 'äºŒæ¨“é™½å°ç´„6å…¬å°ºï¼Œè«‹ç¢ºèªé«˜åº¦',
      type: 'yn',
      condition: () => !state.subAnswers.isChild,
      onYes: () => { addFinding('æˆäººå¢œè½é«˜åº¦ > 6å…¬å°ºï¼ˆå…©å±¤æ¨“ï¼‰'); setMajor(); addAmbulance(); },
    },
    {
      id: 'fall_height_child',
      question: 'å¢œè½é«˜åº¦æ˜¯å¦å¤§æ–¼å…©å€èº«é«˜ï¼ˆç´„3å…¬å°ºï¼‰ï¼Ÿ',
      hint: 'å°å…’ï¼šç´„3å…¬å°ºå³éœ€ç‰¹åˆ¥æ³¨æ„',
      type: 'yn',
      condition: () => state.subAnswers.isChild === true,
      onYes: () => { addFinding('å°å…’å¢œè½é«˜åº¦ > 3å…¬å°ºï¼ˆå…©å€èº«é«˜ï¼‰'); setMajor(); addAmbulance(); },
    },
    {
      id: 'fall_conscious',
      question: 'æ‚£è€…ç›®å‰æ˜¯å¦æœ‰æ„è­˜ï¼Ÿ',
      type: 'yn',
      onNo: () => { addFinding('æ‚£è€…ç„¡æ„è­˜'); setMajor(); addAmbulance(); },
    },
  ],

  vehicle: [
    {
      id: 'veh_gender',
      question: 'æ‚£è€…æ€§åˆ¥ï¼Ÿ',
      type: 'choice',
      options: [
        { label: 'ç”·æ€§', value: 'ç”·' },
        { label: 'å¥³æ€§', value: 'å¥³' },
        { label: 'ä¸è©³', value: 'ä¸è©³' },
      ],
      onSelect: (v) => { state.gender = v; },
    },
    {
      id: 'veh_age',
      question: 'æ‚£è€…å¹´ç´€ï¼Ÿ',
      hint: 'æ³¨æ„è€äººèˆ‡å°å…’',
      type: 'input',
      placeholder: 'ä¾‹å¦‚: 30æ­²ã€è€å¹´äººã€å°å­©',
      onSubmit: (v) => { state.age = v; },
    },
    {
      id: 'veh_type',
      question: 'æ¶‰åŠä»€éº¼è»Šè¼›ï¼Ÿ',
      type: 'choice',
      options: [
        { label: 'ğŸš— æ±½è»Š', value: 'car' },
        { label: 'ğŸï¸ æ©Ÿè»Š', value: 'moto' },
        { label: 'ğŸš² è‡ªè¡Œè»Š', value: 'bike' },
        { label: 'ğŸš¶ è¡Œäºº', value: 'pedestrian' },
        { label: 'ğŸš› å¤§å‹è»Šè¼›', value: 'truck' },
      ],
      onSelect: (v) => { state.subAnswers.vehType = v; },
    },
    {
      id: 'veh_overturn',
      question: 'æ±½è»Šæ˜¯å¦æ•´å°ç¿»è¦†ï¼Ÿ',
      hint: 'è»Šè¼›ç¿»è¦†ç‚ºé«˜èƒ½é‡æ©Ÿè½‰',
      type: 'yn',
      condition: () => ['car', 'truck'].includes(state.subAnswers.vehType),
      onYes: () => { addFinding('è»Šè¼›ç¿»è¦†'); setMajor(); },
    },
    {
      id: 'veh_trapped_car',
      question: 'ä¹˜å®¢æ˜¯å¦å—å›°è»Šå…§ï¼Ÿç„¡æ³•è‡ªè¡Œè„«å›°ï¼Ÿ',
      hint: 'å—å›°éœ€è¦æœæ•‘å™¨æ',
      type: 'yn',
      condition: () => state.subAnswers.vehType === 'car' || state.subAnswers.vehType === 'truck',
      onYes: () => { addFinding('ä¹˜å®¢å—å›°è»Šå…§'); addVehicle('rescue'); addAmbulance(); },
    },
    {
      id: 'veh_ejected',
      question: 'æ‚£è€…æ˜¯å¦å¾è»Šå…§é£›æ‹‹å‡ºè»Šå¤–ï¼Ÿ',
      type: 'yn',
      condition: () => ['car', 'truck'].includes(state.subAnswers.vehType),
      onYes: () => { addFinding('æ‚£è€…å¾è»Šå…§é£›æ‹‹å‡ºè»Šå¤–'); setMajor(); addAmbulance(); },
    },
    {
      id: 'veh_ditch',
      question: 'è»Šè¼›æˆ–äººå“¡æ˜¯å¦æ‰è½æ°´æº/æ©‹ä¸‹/å‘æ´ï¼ˆè¶…é6å…¬å°ºï¼‰ï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('æ‰è½æ°´æº/æ©‹ä¸‹è¶…é6å…¬å°º'); setMajor(); addAmbulance(); },
    },
    {
      id: 'veh_runover',
      question: 'æ‚£è€…èº«é«”æ­£ä¸­é–“æ˜¯å¦è¢«è»Šè¼›è¼¾éï¼Ÿ',
      hint: 'è»€å¹¹è¢«è¼¾å£“ç‚ºåš´é‡æ©Ÿè½‰',
      type: 'yn',
      onYes: () => { addFinding('èº«é«”è¢«è»Šè¼›è¼¾é'); setMajor(); addAmbulance(); },
    },
    {
      id: 'veh_under',
      question: 'æ‚£è€…èº«é«”æ˜¯å¦é‚„å£“åœ¨è»Šä¸‹å‡ºä¸ä¾†ï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('æ‚£è€…å£“åœ¨è»Šä¸‹'); setMajor(); addAmbulance(); addVehicle('rescue'); },
    },
    {
      id: 'veh_deform',
      question: 'æ‚£è€…æ˜¯å¦å› è»Šè¼›è®Šå½¢å—å›°è»Šå…§ï¼Ÿ',
      type: 'yn',
      condition: () => ['car', 'truck'].includes(state.subAnswers.vehType),
      onYes: () => { addFinding('è»Šè¼›è®Šå½¢ï¼Œæ‚£è€…å—å›°è»Šå…§'); setMajor(); addAmbulance(); addVehicle('rescue'); },
    },
    {
      id: 'veh_multi_ohca',
      question: 'å¦‚æœ‰å¤šä½æ‚£è€…ï¼Œæ˜¯å¦å…¶ä¸­ä¸€äººå·²ç‚º OHCAï¼Ÿ',
      hint: 'è‹¥ä¸€äººOHCAï¼ŒåŒè»Šå…¶ä»–æ‚£è€…ä¹Ÿæ‡‰åŠ æ´¾äºŒè»Š',
      type: 'yn',
      condition: () => state.patientCount > 1,
      onYes: () => { addFinding('åŒè»Šå¦ä¸€æ‚£è€…ç‚ºOHCAï¼Œæœ¬æ‚£è€…åŠ æ´¾'); setMajor(); addAmbulance(); },
    },
    {
      id: 'veh_conscious',
      question: 'æ‚£è€…ç›®å‰æ˜¯å¦æœ‰æ„è­˜ï¼Ÿ',
      type: 'yn',
      onNo: () => { addFinding('æ‚£è€…ç„¡æ„è­˜'); setMajor(); addAmbulance(); },
    },
  ],

  machine: [
    {
      id: 'mach_what',
      question: 'æ˜¯ä»€éº¼æ©Ÿå™¨é€ æˆçš„å‚·å®³ï¼Ÿ',
      type: 'input',
      placeholder: 'ä¾‹å¦‚: æ²–å£“æ©Ÿã€è¼¸é€å¸¶ã€åˆ‡å‰²æ©Ÿã€è¾²æ©Ÿ...',
      onSubmit: (v) => { state.subAnswers.machineType = v; addFinding(`æ©Ÿå™¨é¡å‹ï¼š${v}`); },
    },
    {
      id: 'mach_stuck',
      question: 'æ‚£è€…æ˜¯å¦é‚„å¡åœ¨æ©Ÿå™¨è£¡é¢ï¼Ÿéœ€è¦æœæ•‘æˆ–ç ´å£å™¨æï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('æ‚£è€…å¡åœ¨æ©Ÿå™¨ä¸­ï¼Œéœ€æœæ•‘/ç ´å£å™¨æ'); setMajor(); addAmbulance(); addVehicle('rescue'); },
    },
    {
      id: 'mach_gender',
      question: 'æ‚£è€…æ€§åˆ¥ï¼Ÿ',
      type: 'choice',
      options: [
        { label: 'ç”·æ€§', value: 'ç”·' },
        { label: 'å¥³æ€§', value: 'å¥³' },
        { label: 'ä¸è©³', value: 'ä¸è©³' },
      ],
      onSelect: (v) => { state.gender = v; },
    },
    {
      id: 'mach_age',
      question: 'æ‚£è€…å¹´ç´€ï¼Ÿ',
      type: 'input',
      placeholder: 'ä¾‹å¦‚: 40æ­²',
      onSubmit: (v) => { state.age = v; },
    },
    {
      id: 'mach_rolled',
      question: 'æ˜¯å¦æ•´å€‹äººè¢«æ²é€²æ©Ÿå™¨è£¡é¢ï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('æ•´å€‹äººè¢«æ²é€²æ©Ÿå™¨'); setMajor(); addAmbulance(); },
    },
    {
      id: 'mach_limb_stuck',
      question: 'æ˜¯å¦æœ‰æ‰‹è…³æ²é€²æ©Ÿå™¨è£¡é¢ç„¡æ³•è„«å›°ä¸”æŒçºŒå‡ºè¡€ï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('æ‰‹è…³æ²å…¥æ©Ÿå™¨ï¼ŒæŒçºŒå‡ºè¡€'); setMajor(); addAmbulance(); },
    },
    {
      id: 'mach_ampu',
      question: 'æ˜¯å¦æœ‰è‚¢é«”è¢«æˆªè‚¢çš„ç‹€æ³ï¼Ÿï¼ˆæ‰‹è…•/è…³è¸ä»¥ä¸Šï¼‰',
      hint: 'åƒ…é™æ–¼æ‰‹æŒæˆ–è…³æŒçš„ä¸ç®—',
      type: 'yn',
      onYes: () => { addFinding('æ‰‹è…•/è…³è¸ä»¥ä¸Šæˆªè‚¢'); setMajor(); addAmbulance(); },
    },
    {
      id: 'mach_penetrate',
      question: 'æ©Ÿå…·æ˜¯å¦ç©¿åˆºå¤§è…¿/æ‰‹è‚˜ä»¥ä¸Š/é ­é ¸éƒ¨/èƒ¸éƒ¨/è…¹éƒ¨/èƒŒéƒ¨ï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('æ©Ÿå…·ç©¿åˆºé‡è¦éƒ¨ä½'); },
    },
    {
      id: 'mach_bleeding',
      question: 'ç©¿åˆºå‚·å£æ˜¯å¦æŒçºŒæ¹§å‡ºè¡€æ°´ï¼Ÿ',
      type: 'yn',
      condition: () => state.findings.includes('æ©Ÿå…·ç©¿åˆºé‡è¦éƒ¨ä½'),
      onYes: () => { addFinding('å‚·å£æŒçºŒæ¹§å‡ºè¡€æ°´'); setMajor(); addAmbulance(); },
    },
    {
      id: 'mach_organs',
      question: 'å‚·å£è£¡é¢æœ‰æ²’æœ‰çœ‹åˆ°è…¸å­æˆ–å…¶ä»–å™¨å®˜æ‰å‡ºä¾†ï¼Ÿ',
      type: 'yn',
      condition: () => state.findings.includes('æ©Ÿå…·ç©¿åˆºé‡è¦éƒ¨ä½'),
      onYes: () => { addFinding('å™¨å®˜å¤–éœ²'); setMajor(); addAmbulance(); },
    },
  ],

  crush: [
    {
      id: 'crush_trapped',
      question: 'æ‚£è€…æ˜¯å¦å—å›°ï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('æ‚£è€…å—å›°'); addVehicle('rescue'); },
    },
    {
      id: 'crush_gender',
      question: 'æ‚£è€…æ€§åˆ¥ï¼Ÿ',
      type: 'choice',
      options: [
        { label: 'ç”·æ€§', value: 'ç”·' },
        { label: 'å¥³æ€§', value: 'å¥³' },
        { label: 'ä¸è©³', value: 'ä¸è©³' },
      ],
      onSelect: (v) => { state.gender = v; },
    },
    {
      id: 'crush_age',
      question: 'æ‚£è€…å¹´ç´€ï¼Ÿ',
      type: 'input',
      placeholder: 'ä¾‹å¦‚: 55æ­²',
      onSubmit: (v) => { state.age = v; },
    },
    {
      id: 'crush_what',
      question: 'æ˜¯ä»€éº¼æ±è¥¿å€’å¡Œå£“åˆ°æ‚£è€…ï¼Ÿå¤§æ¦‚æœ‰å¤šé‡ï¼Ÿ',
      hint: 'æ´¾é£å“¡è‡ªè¡Œåˆ¤æ–·æ˜¯å¦ç‚ºé«˜å±éšªæ©Ÿè½‰',
      type: 'input',
      placeholder: 'ä¾‹å¦‚: é·¹æ¶å€’å¡Œã€ç‰†å£å€’å¡Œã€é‡å‹æ©Ÿå…·...',
      onSubmit: (v) => { addFinding(`å£“ç ¸ç‰©ï¼š${v}`); },
    },
    {
      id: 'crush_whole',
      question: 'æ‚£è€…æ˜¯æ•´å€‹äººè¢«å£“ä½ï¼Œé‚„æ˜¯åªæœ‰èº«é«”æŸä¸€å€‹éƒ¨ä½ï¼Ÿ',
      type: 'choice',
      options: [
        { label: 'æ•´å€‹äººè¢«å£“ä½', value: 'whole' },
        { label: 'åªæœ‰æŸå€‹éƒ¨ä½', value: 'part' },
      ],
      onSelect: (v) => {
        if (v === 'whole') { addFinding('æ•´å€‹äººè¢«å£“ä½'); setMajor(); addAmbulance(); }
      },
    },
    {
      id: 'crush_chest',
      question: 'æ‚£è€…èƒ¸å£æˆ–è‚šå­æ˜¯å¦è¢«é‡ç‰©å£“ä½ï¼Œç›®å‰å‡ºä¸ä¾†ï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('èƒ¸/è…¹éƒ¨è¢«é‡ç‰©å£“ä½'); setMajor(); addAmbulance(); },
    },
    {
      id: 'crush_buried',
      question: 'æ‚£è€…æ•´å€‹äººæ˜¯å¦è¢«åŸ‹èµ·ä¾†äº†ï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('æ‚£è€…è¢«æ©åŸ‹'); setMajor(); addAmbulance(); },
    },
    {
      id: 'crush_time',
      question: 'é‡ç‰©å£“ä½æ‚£è€…å¾Œå—å›°å¤šä¹…ï¼Ÿæ˜¯å¦è¶…é20åˆ†é˜ï¼Ÿ',
      hint: 'å—å›°è¶…é20åˆ†é˜æœ‰å£“ç ¸ç—‡å€™ç¾¤é¢¨éšª',
      type: 'yn',
      onYes: () => { addFinding('å—å›°è¶…é20åˆ†é˜'); setMajor(); addAmbulance(); },
    },
  ],

  stab: [
    {
      id: 'stab_gender',
      question: 'æ‚£è€…æ€§åˆ¥ï¼Ÿ',
      type: 'choice',
      options: [
        { label: 'ç”·æ€§', value: 'ç”·' },
        { label: 'å¥³æ€§', value: 'å¥³' },
        { label: 'ä¸è©³', value: 'ä¸è©³' },
      ],
      onSelect: (v) => { state.gender = v; },
    },
    {
      id: 'stab_age',
      question: 'æ‚£è€…å¹´ç´€ï¼Ÿ',
      type: 'input',
      placeholder: 'ä¾‹å¦‚: 28æ­²',
      onSubmit: (v) => { state.age = v; },
    },
    {
      id: 'stab_weapon_in',
      question: 'å‡¶å™¨æ˜¯å¦é‚„æ’åœ¨æ‚£è€…èº«ä¸Šï¼Ÿ',
      hint: 'âš ï¸ è‹¥æ˜¯ï¼Œè«‹å‘ŠçŸ¥å ±æ¡ˆè€…ã€Œä¸è¦ç§»é™¤å‡¶å™¨ã€',
      type: 'yn',
      onYes: () => { addFinding('âš ï¸ å‡¶å™¨ä»æ’åœ¨æ‚£è€…èº«ä¸Šï¼ˆå·²æé†’å‹¿ç§»é™¤ï¼‰'); },
    },
    {
      id: 'stab_location',
      question: 'ç©¿åˆºå‚·å£æ˜¯å¦ä½æ–¼é ¸éƒ¨/èƒ¸éƒ¨/è…¹éƒ¨/èƒŒéƒ¨/å¤§è…¿ï¼Ÿ',
      hint: 'é€™äº›éƒ¨ä½çš„ç©¿åˆºå‚·å¯èƒ½å±åŠç”Ÿå‘½',
      type: 'yn',
      onYes: () => { addFinding('ç©¿åˆºå‚·ä½æ–¼é‡è¦éƒ¨ä½ï¼ˆé ¸/èƒ¸/è…¹/èƒŒ/å¤§è…¿ï¼‰'); },
    },
    {
      id: 'stab_bleeding',
      question: 'å‚·å£æ˜¯å¦æŒçºŒæ¹§å‡ºè¡€æ°´ï¼Ÿ',
      type: 'yn',
      condition: () => state.findings.includes('ç©¿åˆºå‚·ä½æ–¼é‡è¦éƒ¨ä½ï¼ˆé ¸/èƒ¸/è…¹/èƒŒ/å¤§è…¿ï¼‰'),
      onYes: () => { addFinding('å‚·å£æŒçºŒæ¹§å‡ºè¡€æ°´'); setMajor(); addAmbulance(); },
    },
    {
      id: 'stab_organs',
      question: 'å‚·å£è£¡é¢æœ‰æ²’æœ‰çœ‹åˆ°è…¸å­æˆ–å…¶ä»–å™¨å®˜æ‰å‡ºä¾†ï¼Ÿ',
      type: 'yn',
      condition: () => state.findings.includes('ç©¿åˆºå‚·ä½æ–¼é‡è¦éƒ¨ä½ï¼ˆé ¸/èƒ¸/è…¹/èƒŒ/å¤§è…¿ï¼‰'),
      onYes: () => { addFinding('å™¨å®˜å¤–éœ²'); setMajor(); addAmbulance(); },
    },
    {
      id: 'stab_conscious',
      question: 'æ‚£è€…ç›®å‰æ˜¯å¦æœ‰æ„è­˜ï¼Ÿ',
      type: 'yn',
      onNo: () => { addFinding('æ‚£è€…ç„¡æ„è­˜'); setMajor(); addAmbulance(); },
    },
  ],

  burn: [
    {
      id: 'burn_gender',
      question: 'æ‚£è€…æ€§åˆ¥ï¼Ÿ',
      type: 'choice',
      options: [
        { label: 'ç”·æ€§', value: 'ç”·' },
        { label: 'å¥³æ€§', value: 'å¥³' },
        { label: 'ä¸è©³', value: 'ä¸è©³' },
      ],
      onSelect: (v) => { state.gender = v; },
    },
    {
      id: 'burn_age',
      question: 'æ‚£è€…å¹´ç´€ï¼Ÿ',
      type: 'input',
      placeholder: 'ä¾‹å¦‚: 35æ­²',
      onSubmit: (v) => { state.age = v; },
    },
    {
      id: 'burn_type',
      question: 'å‚·å®³é¡å‹ï¼Ÿ',
      type: 'choice',
      options: [
        { label: 'ğŸ’¥ çˆ†ç‚¸', value: 'explosion' },
        { label: 'ğŸ”¥ ç‡’ç‡™å‚·/ç«ç½', value: 'burn' },
        { label: 'âš¡ é›»æ“Šå‚·', value: 'electric' },
        { label: 'â˜¢ï¸ åŒ–å­¸ç¼å‚·', value: 'chemical' },
      ],
      onSelect: (v) => { state.subAnswers.burnType = v; addFinding(`å‚·å®³é¡å‹ï¼š${v}`); },
    },
    {
      id: 'burn_explosion',
      question: 'çˆ†ç‚¸æ˜¯å¦é€ æˆäººå“¡è¢«ç‚¸é£›/å¤§é¢ç©å‚·å®³ï¼Ÿ',
      type: 'yn',
      condition: () => state.subAnswers.burnType === 'explosion',
      onYes: () => { addFinding('çˆ†ç‚¸é€ æˆå¤§é¢ç©å‚·å®³'); setMajor(); addAmbulance(); },
    },
    {
      id: 'burn_area',
      question: 'ç‡’ç‡™å‚·é¢ç©æ˜¯å¦è¶…éé«”è¡¨é¢ç©çš„18%ï¼Ÿï¼ˆç´„ä¸€éš»æ‰‹è‡‚+èƒ¸éƒ¨å‰é¢ï¼‰',
      hint: 'æˆäººä¸€éš»æ‰‹è‡‚ç´„9%ã€èƒ¸éƒ¨å‰é¢ç´„9%',
      type: 'yn',
      condition: () => ['burn', 'chemical'].includes(state.subAnswers.burnType),
      onYes: () => { addFinding('å¤§é¢ç©ç‡’ç‡™å‚· >18% TBSA'); setMajor(); addAmbulance(); },
    },
    {
      id: 'burn_airway',
      question: 'æ‚£è€…æ˜¯å¦æœ‰å¸å…¥æ€§ç¼å‚·çš„è·¡è±¡ï¼Ÿï¼ˆè‡‰éƒ¨ç‡’å‚·ã€é¼»æ¯›ç‡’ç„¦ã€è²éŸ³å˜¶å•ï¼‰',
      type: 'yn',
      onYes: () => { addFinding('ç–‘ä¼¼å¸å…¥æ€§ç¼å‚·'); setMajor(); addAmbulance(); },
    },
    {
      id: 'burn_conscious',
      question: 'æ‚£è€…ç›®å‰æ˜¯å¦æœ‰æ„è­˜ï¼Ÿ',
      type: 'yn',
      onNo: () => { addFinding('æ‚£è€…ç„¡æ„è­˜'); setMajor(); addAmbulance(); },
    },
    {
      id: 'burn_multi',
      question: 'æ˜¯å¦æœ‰å¤šåå‚·æ‚£ï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('å¤šåå‚·æ‚£'); addAmbulance(); },
    },
  ],

  other: [
    {
      id: 'other_gender',
      question: 'æ‚£è€…æ€§åˆ¥ï¼Ÿ',
      type: 'choice',
      options: [
        { label: 'ç”·æ€§', value: 'ç”·' },
        { label: 'å¥³æ€§', value: 'å¥³' },
        { label: 'ä¸è©³', value: 'ä¸è©³' },
      ],
      onSelect: (v) => { state.gender = v; },
    },
    {
      id: 'other_age',
      question: 'æ‚£è€…å¹´ç´€ï¼Ÿ',
      type: 'input',
      placeholder: 'ä¾‹å¦‚: 50æ­²',
      onSubmit: (v) => { state.age = v; },
    },
    {
      id: 'other_desc',
      question: 'è«‹ç°¡è¿°å‚·å®³æƒ…æ³ï¼š',
      type: 'input',
      placeholder: 'ä¾‹å¦‚: æººæ°´ã€é›»æ“Šã€å‹•ç‰©å’¬å‚·...',
      onSubmit: (v) => { addFinding(`å‚·å®³æè¿°ï¼š${v}`); },
    },
    {
      id: 'other_conscious',
      question: 'æ‚£è€…ç›®å‰æ˜¯å¦æœ‰æ„è­˜ï¼Ÿ',
      type: 'yn',
      onNo: () => { addFinding('æ‚£è€…ç„¡æ„è­˜'); setMajor(); addAmbulance(); },
    },
    {
      id: 'other_breathing',
      question: 'æ‚£è€…æ˜¯å¦æœ‰æ­£å¸¸å‘¼å¸ï¼Ÿ',
      type: 'yn',
      onNo: () => { addFinding('å‘¼å¸ç•°å¸¸'); setMajor(); addAmbulance(); },
    },
    {
      id: 'other_bleeding',
      question: 'æ˜¯å¦æœ‰å¤§é‡å‡ºè¡€ï¼Ÿ',
      type: 'yn',
      onYes: () => { addFinding('å¤§é‡å‡ºè¡€'); setMajor(); addAmbulance(); },
    },
  ],
};

// ===== HELPER FUNCTIONS =====
function addFinding(f) {
  if (!state.findings.includes(f)) state.findings.push(f);
}

function setMajor() {
  state.isMajor = true;
  state.dispatchLevel = 'critical';
}

function addAmbulance() {
  if (state.vehicles.ambulance < 2) state.vehicles.ambulance = 2;
}

function addVehicle(type) {
  if (type === 'rescue') state.vehicles.rescue = Math.max(state.vehicles.rescue, 1);
}

function addLog(question, answer) {
  state.log.push({ q: question, a: answer });
}

function resetAll() {
  if (!confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡è¢«æ¸…é™¤ã€‚')) return;
  Object.assign(state, {
    step: 'basic',
    patientCount: 1,
    incidentType: '',
    isOHCA: false,
    gender: '',
    age: '',
    isMajor: false,
    dispatchLevel: 'normal',
    vehicles: { ambulance: 1, rescue: 0 },
    findings: [],
    log: [],
    subStep: 0,
    subAnswers: {},
    startTime: Date.now(),
  });
  render();
}

// ===== RENDER ENGINE =====
function render() {
  const app = document.getElementById('app');

  let html = '';

  // Progress bar
  const steps = ['basic', 'ohca_check', 'incident_type', 'detail_questions', 'summary'];
  const currentIdx = steps.indexOf(state.step);
  const progress = state.step === 'summary' ? 100 : Math.max(10, ((currentIdx + 1) / steps.length) * 100);
  html += `<div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>`;

  // Dispatch status banner
  html += renderDispatchBanner();

  // Step content
  switch (state.step) {
    case 'basic': html += renderBasicInfo(); break;
    case 'ohca_check': html += renderOHCACheck(); break;
    case 'incident_type': html += renderIncidentType(); break;
    case 'detail_questions': html += renderDetailQuestions(); break;
    case 'summary': html += renderSummary(); break;
  }

  app.innerHTML = html;
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function renderDispatchBanner() {
  let level, icon, text;
  if (state.isOHCA) {
    level = 'critical'; icon = 'ğŸš¨'; text = `OHCA â€” æ´¾é£ ${state.vehicles.ambulance} è¼›æ•‘è­·è»Š`;
  } else if (state.isMajor) {
    level = 'critical'; icon = 'ğŸš¨';
    const parts = [`${state.vehicles.ambulance} è¼›æ•‘è­·è»Š`];
    if (state.vehicles.rescue > 0) parts.push(`${state.vehicles.rescue} è¼›æ•‘ç½è»Š`);
    text = `é‡å¤§å¤–å‚· â€” æ´¾é£ ${parts.join(' + ')}`;
  } else if (state.dispatchLevel === 'warning') {
    level = 'warning'; icon = 'âš ï¸'; text = 'è©•ä¼°ä¸­ â€” éœ€é€²ä¸€æ­¥ç¢ºèª';
  } else {
    level = 'normal'; icon = 'ğŸŸ¢'; text = `ä¸€èˆ¬æ´¾é£ â€” ${state.vehicles.ambulance} è¼›æ•‘è­·è»Š`;
  }
  return `
    <div class="dispatch-banner level-${level}">
      <span class="icon">${icon}</span>
      <div class="details">
        <div class="label">ç›®å‰æ´¾é£å»ºè­°</div>
        <div>${text}</div>
      </div>
    </div>
  `;
}

function renderBasicInfo() {
  return `
    <div class="card">
      <div class="card-step">æ­¥é©Ÿ 1/4</div>
      <div class="card-title">ğŸ“‹ åŸºæœ¬è³‡è¨Š</div>
      <div class="card-desc">è«‹å…ˆç¢ºèªæ¡ˆä»¶åŸºæœ¬è³‡è¨Š</div>

      <div class="form-group">
        <label>ğŸ‘¥ æ‚£è€…ç¸½äººæ•¸</label>
        <div class="yn-grid">
          ${[1,2,3,'4+'].map(n => `
            <button class="yn-btn ${state.patientCount == n ? 'yes-btn selected' : ''}"
                    onclick="state.patientCount = ${typeof n === 'number' ? n : 4}; render()">
              ${n} äºº
            </button>
          `).join('')}
        </div>
      </div>

      <div class="action-row">
        <button class="btn btn-primary" onclick="goToOHCA()">
          ä¸‹ä¸€æ­¥ â†’
        </button>
      </div>
    </div>
  `;
}

function goToOHCA() {
  addLog('æ‚£è€…äººæ•¸', `${state.patientCount} äºº`);
  state.step = 'ohca_check';
  render();
}

function renderOHCACheck() {
  return `
    <div class="card completed">
      <div class="card-header"><div class="card-title">ğŸ“‹ åŸºæœ¬è³‡è¨Š</div></div>
      <div class="card-body">
        <div class="log-entry"><span class="q">äººæ•¸</span><span class="a">${state.patientCount} äºº</span></div>
      </div>
    </div>

    <div class="card">
      <div class="card-step">æ­¥é©Ÿ 2/4</div>
      <div class="card-title">ğŸ’” OHCA ç¢ºèª</div>
      <div class="card-desc">æ‚£è€…æ˜¯å¦å·²ç„¡å‘¼å¸å¿ƒè·³ï¼ˆOHCAï¼‰ï¼Ÿ</div>
      <div class="card-hint">
        âš ï¸ è‹¥æ‚£è€…ç‚º OHCAï¼Œå°‡ç«‹å³æ´¾é£é›™è»Šï¼Œä¸éœ€é€²ä¸€æ­¥è©•ä¼°æ©Ÿè½‰ã€‚
      </div>
      <div class="yn-grid">
        <button class="yn-btn yes-btn" onclick="handleOHCAYes()">
          âš ï¸ æ˜¯ OHCA
        </button>
        <button class="yn-btn no-btn" onclick="handleOHCANo()">
          âœ“ å¦ / ä¸ç¢ºå®š
        </button>
      </div>
    </div>
  `;
}

function handleOHCAYes() {
  state.isOHCA = true;
  state.isMajor = true;
  state.dispatchLevel = 'critical';
  state.vehicles.ambulance = 2;
  addFinding('æ‚£è€… OHCA');
  addLog('æ˜¯å¦ OHCA', 'æ˜¯ â†’ ç«‹å³æ´¾é£é›™è»Š');
  state.step = 'summary';
  render();
}

function handleOHCANo() {
  addLog('æ˜¯å¦ OHCA', 'å¦');
  state.step = 'incident_type';
  render();
}

function renderIncidentType() {
  return `
    <div class="card completed">
      <div class="card-header"><div class="card-title">ğŸ“‹ åŸºæœ¬è³‡è¨Š + OHCA ç¢ºèª</div></div>
    </div>

    <div class="card">
      <div class="card-step">æ­¥é©Ÿ 3/4</div>
      <div class="card-title">ğŸ” äº‹æ•…é¡å‹è¾¨è­˜</div>
      <div class="card-desc">è¾¨è­˜ç‚ºå¤–ç§‘å¾Œï¼Œè«‹é¸æ“‡å—å‚·æ©Ÿè½‰é¡å‹ï¼š</div>
      <div class="choice-grid">
        ${incidentTypes.map(t => `
          <button class="choice-btn" onclick="selectIncidentType('${t.id}')">
            <span class="choice-icon">${t.icon}</span>
            <div class="choice-text">
              <div>${t.label}</div>
              <div class="sub">${t.sub}</div>
            </div>
          </button>
        `).join('')}
      </div>
    </div>
  `;
}

function selectIncidentType(type) {
  state.incidentType = type;
  const t = incidentTypes.find(x => x.id === type);
  addLog('äº‹æ•…é¡å‹', t.label);
  state.subStep = 0;
  state.step = 'detail_questions';
  render();
}

function renderDetailQuestions() {
  const tree = questionTrees[state.incidentType] || questionTrees.other;
  const typeName = incidentTypes.find(x => x.id === state.incidentType)?.label || 'å…¶ä»–';

  // Find current question (skip conditions that aren't met)
  let currentQ = null;
  let currentIdx = state.subStep;
  while (currentIdx < tree.length) {
    const q = tree[currentIdx];
    if (q.condition && !q.condition()) {
      currentIdx++;
      state.subStep = currentIdx;
      continue;
    }
    currentQ = q;
    break;
  }

  // If no more questions, go to summary
  if (!currentQ) {
    state.step = 'summary';
    return renderSummary();
  }

  let html = `
    <div class="card completed">
      <div class="card-header"><div class="card-title">ğŸ“‹ åŸºæœ¬è³‡è¨Š â†’ ${typeName}</div></div>
    </div>
  `;

  // Show completed question log
  if (state.log.length > 2) {
    html += `<div class="card" style="padding:16px">
      <div style="font-size:14px;font-weight:600;color:var(--gray-500);margin-bottom:8px;">ğŸ“ å·²è¨˜éŒ„çš„å›ç­”</div>
      ${state.log.slice(2).map(l => `
        <div class="log-entry">
          <span class="q">${l.q}</span>
          <span class="a">${l.a}</span>
        </div>
      `).join('')}
    </div>`;
  }

  // Current question
  html += `
    <div class="card">
      <div class="card-step">æ­¥é©Ÿ 4 â€” æ©Ÿè½‰è¿½å• (${currentIdx + 1}/${tree.length})</div>
      <div class="card-title">${currentQ.question}</div>
      ${currentQ.hint ? `<div class="card-hint">ğŸ’¡ ${currentQ.hint}</div>` : ''}
  `;

  switch (currentQ.type) {
    case 'yn':
      html += `
        <div class="yn-grid">
          <button class="yn-btn yes-btn" onclick="answerYN('${currentQ.id}', true)">âœ… æ˜¯</button>
          <button class="yn-btn no-btn" onclick="answerYN('${currentQ.id}', false)">âŒ å¦ / ä¸ç¢ºå®š</button>
        </div>
      `;
      break;
    case 'choice':
      html += `<div class="choice-grid">
        ${currentQ.options.map(o => `
          <button class="choice-btn" onclick="answerChoice('${currentQ.id}', '${o.value}', '${o.label}')">
            <div class="choice-text"><div>${o.label}</div></div>
          </button>
        `).join('')}
      </div>`;
      break;
    case 'input':
      html += `
        <div class="form-group">
          <input class="form-input" id="inp_${currentQ.id}" type="text"
                 placeholder="${currentQ.placeholder || ''}"
                 onkeypress="if(event.key==='Enter')answerInput('${currentQ.id}')">
        </div>
        <div class="action-row">
          <button class="btn btn-primary" onclick="answerInput('${currentQ.id}')">ç¢ºèª â†’</button>
        </div>
      `;
      break;
  }

  // Skip button
  html += `
    <div class="action-row" style="margin-top:12px">
      <button class="btn btn-secondary" onclick="skipQuestion()">è·³éæ­¤é¡Œ â†’</button>
      <button class="btn btn-secondary" onclick="finishEarly()">çµæŸè©•ä¼° â†’</button>
    </div>
  `;

  html += `</div>`;
  return html;
}

function answerYN(id, isYes) {
  const tree = questionTrees[state.incidentType] || questionTrees.other;
  const q = tree.find(x => x.id === id);
  if (!q) return;

  addLog(q.question, isYes ? 'æ˜¯' : 'å¦');
  if (isYes && q.onYes) q.onYes();
  if (!isYes && q.onNo) q.onNo();

  state.subStep++;
  render();
}

function answerChoice(id, value, label) {
  const tree = questionTrees[state.incidentType] || questionTrees.other;
  const q = tree.find(x => x.id === id);
  if (!q) return;

  addLog(q.question, label);
  if (q.onSelect) q.onSelect(value);

  state.subStep++;
  render();
}

function answerInput(id) {
  const inp = document.getElementById(`inp_${id}`);
  if (!inp || !inp.value.trim()) {
    alert('è«‹è¼¸å…¥å›ç­”');
    return;
  }
  const tree = questionTrees[state.incidentType] || questionTrees.other;
  const q = tree.find(x => x.id === id);
  if (!q) return;

  addLog(q.question, inp.value.trim());
  if (q.onSubmit) q.onSubmit(inp.value.trim());

  state.subStep++;
  render();
}

function skipQuestion() {
  const tree = questionTrees[state.incidentType] || questionTrees.other;
  if (state.subStep < tree.length) {
    addLog(tree[state.subStep].question, 'ï¼ˆè·³éï¼‰');
  }
  state.subStep++;
  render();
}

function finishEarly() {
  state.step = 'summary';
  render();
}

function renderSummary() {
  const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
  const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
  const s = String(elapsed % 60).padStart(2, '0');
  const typeName = incidentTypes.find(x => x.id === state.incidentType)?.label || 'å…¶ä»–';

  const vehicleDesc = [];
  vehicleDesc.push(`ğŸš‘ æ•‘è­·è»Š Ã— ${state.vehicles.ambulance}`);
  if (state.vehicles.rescue > 0) vehicleDesc.push(`ğŸš’ æ•‘ç½è»Š Ã— ${state.vehicles.rescue}`);

  let html = `
    <div class="summary-section">
      <div class="summary-title">ğŸ“‹ æ´¾é£æ±ºç­–ç¸½çµå ±å‘Š</div>

      <div class="dispatch-result ${state.isMajor ? 'major' : 'normal'}">
        <div class="dr-title">${state.isMajor ? 'ğŸš¨ åˆ¤å®šç‚ºé‡å¤§å¤–å‚·' : 'ğŸŸ¢ éé‡å¤§å¤–å‚·'}</div>
        <div>${state.isOHCA ? 'OHCA ç·Šæ€¥æ¡ˆä»¶' : typeName}</div>
        <div class="dr-vehicles">${vehicleDesc.join(' ï¼‹ ')}</div>
      </div>

      <div class="summary-grid" style="margin-top:20px">
        <div class="summary-item">
          <div class="s-label">æ‚£è€…äººæ•¸</div>
          <div class="s-value">${state.patientCount} äºº</div>
        </div>
        <div class="summary-item">
          <div class="s-label">æ‚£è€…æ€§åˆ¥</div>
          <div class="s-value">${state.gender || 'ä¸è©³'}</div>
        </div>
        <div class="summary-item">
          <div class="s-label">æ‚£è€…å¹´ç´€</div>
          <div class="s-value">${state.age || 'ä¸è©³'}</div>
        </div>
        <div class="summary-item">
          <div class="s-label">äº‹æ•…é¡å‹</div>
          <div class="s-value">${typeName}</div>
        </div>
        <div class="summary-item">
          <div class="s-label">é€šè©±æ™‚é–“</div>
          <div class="s-value">${m}:${s}</div>
        </div>
      </div>
  `;

  if (state.findings.length > 0) {
    html += `
      <div class="key-findings">
        <h4>ğŸ”‘ é—œéµç™¼ç¾ï¼ˆåˆ¤å®šä¾æ“šï¼‰</h4>
        <ul>
          ${state.findings.map(f => `<li>${f}</li>`).join('')}
        </ul>
      </div>
    `;
  }

  // Full Q&A log
  html += `
    <div style="margin-top:20px">
      <h4 style="color:var(--gray-700);margin-bottom:10px">ğŸ“ å®Œæ•´å•ç­”è¨˜éŒ„</h4>
      ${state.log.map(l => `
        <div class="log-entry">
          <span class="q">${l.q}</span>
          <span class="a">${l.a}</span>
        </div>
      `).join('')}
    </div>
  `;

  // Dispatch recommendation details
  html += `
    <div style="margin-top:20px; padding:16px; background:var(--primary-light); border-radius:var(--radius); border:1px solid var(--primary);">
      <h4 style="color:var(--primary);margin-bottom:8px">ğŸš‘ æ´¾é£å»ºè­°æ˜ç´°</h4>
      <table style="width:100%;border-collapse:collapse;">
        <tr style="border-bottom:1px solid var(--gray-200)">
          <td style="padding:8px;font-weight:600">æ•‘è­·è»Š</td>
          <td style="padding:8px">${state.vehicles.ambulance} è¼›${state.vehicles.ambulance >= 2 ? ' âš ï¸ åŠ æ´¾' : ''}</td>
        </tr>
        <tr style="border-bottom:1px solid var(--gray-200)">
          <td style="padding:8px;font-weight:600">æ•‘ç½è»Š</td>
          <td style="padding:8px">${state.vehicles.rescue > 0 ? state.vehicles.rescue + ' è¼› âš ï¸ åŠ æ´¾' : 'ä¸éœ€è¦'}</td>
        </tr>
      </table>
    </div>
  `;

  // === Plain text summary for copy/paste (concise one-liner) ===
  const parts = [];
  parts.push(`å—å‚·äººæ•¸${state.patientCount}äºº`);

  // Consciousness: check findings for ç„¡æ„è­˜ or OHCA
  if (state.isOHCA) {
    parts.push('OHCA');
  } else if (state.findings.some(f => f.includes('ç„¡æ„è­˜'))) {
    parts.push('ç„¡æ„è­˜');
  } else {
    parts.push('æ¸…é†’');
  }

  // Incident type
  parts.push(typeName);

  // Key findings (concise)
  state.findings.forEach(f => {
    // Skip consciousness-related findings (already handled above)
    if (f.includes('ç„¡æ„è­˜')) return;
    parts.push(f);
  });

  // Dispatch vehicles
  parts.push(`æ´¾æ•‘è­·${state.vehicles.ambulance}è»Š`);
  if (state.vehicles.rescue > 0) parts.push(`æ´¾æ•‘ç½${state.vehicles.rescue}è»Š`);

  // Gender & Age
  parts.push(`æ€§åˆ¥${state.gender || 'ä¸è©³'}`);
  parts.push(`å¹´é½¡${state.age || ''}æ­²`);

  const plainText = parts.join('ï¼Œ');

  html += `
    <div class="plaintext-box">
      <div class="plaintext-header">
        <h4>ç¾å ´ç‹€æ³ï¼ˆè¤‡è£½ä»¥ä¸‹æ–‡å­—è‡³æ´¾é£ç³»çµ±ï¼‰</h4>
        <button class="copy-btn" id="copyBtn" onclick="copyPlainText()">ğŸ“‹ è¤‡è£½å…¨æ–‡</button>
      </div>
      <div class="plaintext-content" id="plainTextContent">${plainText}</div>
    </div>
  `;

  html += `
    </div>

    <div class="action-row">
      <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±å‘Š</button>
      <button class="btn btn-danger" onclick="resetAll()">ğŸ”„ æ–°æ¡ˆä»¶</button>
    </div>
  `;

  return html;
}

function copyPlainText() {
  const text = document.getElementById('plainTextContent').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.classList.add('copied');
    btn.innerHTML = 'âœ… å·²è¤‡è£½';
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = 'ğŸ“‹ è¤‡è£½å…¨æ–‡';
    }, 2000);
  }).catch(() => {
    // Fallback for older browsers
    const range = document.createRange();
    range.selectNodeContents(document.getElementById('plainTextContent'));
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    document.execCommand('copy');
    const btn = document.getElementById('copyBtn');
    btn.innerHTML = 'âœ… å·²è¤‡è£½';
    setTimeout(() => { btn.innerHTML = 'ğŸ“‹ è¤‡è£½å…¨æ–‡'; }, 2000);
  });
}

// ===== INIT =====
render();
</script>

</body>
</html>
